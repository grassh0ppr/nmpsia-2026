<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-K650CFV8ZV"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-K650CFV8ZV");
    </script>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Find contact information for participating employers in the New Mexico Public Schools Insurance Authority"
    />
    <!-- Favicon -->
    <link rel="icon" href="images/favicon-1.png" />

    <!-- Google Search Console meta tag for verification -->
    <meta
      name="google-site-verification"
      content="rqcincgiDm3fmRsAl4P-ef0nL-Q1i1yO_FKW3X5J8Us"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <title>
      District Contacts | New Mexico Public Schools Insurance Authority
    </title>
    <!-- font awesome -->
    <script
      src="https://kit.fontawesome.com/87331b3d9e.js"
      crossorigin="anonymous"
    ></script>
    <!-- Boxicons styles, used as a font -->
    <link
      href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css"
      rel="stylesheet"
    />

    <!-- custom stylesheets -->
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/queries.css" />
    <link rel="stylesheet" href="styles/district-contacts.css" />

    <!-- components in semi alphabetical order -->
    <script src="./scripts/components/navbar/webflow-navbar-component.js"></script>
    <script src="./scripts/components/footer/footer-sitemap.js"></script>
  </head>

  <body class="modern-body contacts-modern">
    <webflow-navbar-component></webflow-navbar-component>

    <div class="modern-breadcrumb" aria-label="breadcrumb">
      <ol class="ms-4 breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">
          District Contacts
        </li>
      </ol>
    </div>

    <main>
      <div class="container">
        <!-- Hero Section -->
        <section class="contacts-hero-section">
          <div class="contacts-hero-content">
            <h1 class="contacts-hero-title">District Contact Database</h1>
            <p class="contacts-hero-subtitle">
              Find contact information for participating employers in the New
              Mexico Public Schools Insurance Authority
            </p>
          </div>
          <div class="contacts-hero-logo">
            <img
              src="images/nmpsia_logo_2024.png"
              alt="NMPSIA logo"
              class="contacts-logo"
            />
          </div>
        </section>

        <!-- Contact Update Notice -->
        <section class="contact-update-notice">
          <div class="notice-content">
            <div class="notice-icon">
              <i class="bx bx-info-circle"></i>
            </div>
            <div class="notice-text">
              <h3>Need to Update Your Contacts?</h3>
              <p>
                If you need to update your district/charter/participating entity
                contacts, please download and complete the electronic fillable
                form PDF linked below, then send it as an email attachment to
                Erisa Administrative Services.
                <strong
                  >(If you have more than one contact for the job categories
                  listed, please complete additional forms to include all
                  contacts.)</strong
                >
              </p>
              <div class="notice-actions">
                <a
                  href="https://nmpsia.com/pdfs/forms/Fillable_Contact_Form_updated_with_signature_line.pdf"
                  target="_blank"
                  class="btn btn-primary"
                >
                  <i class="bx bx-download"></i>
                  Download Contact Update Form
                </a>
                <a href="mailto:sf@easitpa.com" class="btn btn-outline-primary">
                  <i class="bx bx-envelope"></i>
                  Email Erisa Administrative Services
                </a>
              </div>
            </div>
          </div>
        </section>

        <!-- Search Section -->
        <section class="contacts-content-section">
          <div class="search-container">
            <div class="position-relative">
              <input
                type="search"
                id="searchInput"
                class="search-input"
                placeholder="Search by district name or ID..."
                aria-label="Search districts"
              />
            </div>
          </div>

          <!-- Stats Bar -->
          <div class="stats-bar" id="statsBar" style="display: none">
            <div class="stat-item">
              <div class="stat-number" id="totalDistricts">0</div>
              <div class="stat-label">Total Districts</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="totalContacts">0</div>
              <div class="stat-label">Total Contacts</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="filteredResults">0</div>
              <div class="stat-label">Showing</div>
            </div>
          </div>

          <!-- Loading State -->
          <div id="loadingState" class="loading-spinner">
            <div
              class="spinner"
              role="status"
              aria-label="Loading districts"
            ></div>
            <span class="ms-3">Loading district information...</span>
          </div>

          <!-- No Results State -->
          <div id="noResults" class="no-results" style="display: none">
            <i class="bx bx-search" style="font-size: 3rem; color: #6c757d"></i>
            <h3>No districts found</h3>
            <p>
              Try adjusting your search terms or browse all districts below.
            </p>
          </div>

          <!-- Districts Grid -->
          <div
            id="districtsGrid"
            class="district-grid"
            style="display: none"
          ></div>
        </section>

        <!-- Contact Details Modal -->
        <div
          class="modal fade"
          id="contactDetailsModal"
          tabindex="-1"
          aria-labelledby="contactDetailsModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="contactDetailsModalLabel">
                  District Contact Information
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically populated -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer-sitemap></footer-sitemap>

    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>

    <!-- smooth scroll polyfill -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/smooth-scroll/16.1.3/smooth-scroll.min.js"
      integrity="sha512-HYG9E+RmbXS7oy529Nk8byKFw5jqM3R1zzvoV2JnltsIGkK/AhZSzciYCNxDMOXEbYO9w6MJ6SpuYgm5PJPpeQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- IONICONS FOR NAVBAR -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>

    <!-- Google search bar functionality -->
    <script
      async
      src="https://cse.google.com/cse.js?cx=1a04339760c2f9046"
    ></script>

    <script>
      // Global variables
      let allDistricts = [];
      let allContacts = [];
      let filteredDistricts = [];
      let loadingTimeout;

      // Copy to clipboard function - defined globally
      function copyToClipboard(text, button) {
        // Try to use the modern Clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard
            .writeText(text)
            .then(() => {
              showCopyFeedback(button);
            })
            .catch((err) => {
              console.error("Failed to copy: ", err);
              // Fallback to the old method
              fallbackCopyToClipboard(text, button);
            });
        } else {
          // Fallback for older browsers or non-secure contexts
          fallbackCopyToClipboard(text, button);
        }
      }

      // Fallback copy method for older browsers
      function fallbackCopyToClipboard(text, button) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);

        try {
          textarea.select();
          document.execCommand("copy");
          showCopyFeedback(button);
        } catch (err) {
          console.error("Fallback copy failed: ", err);
        } finally {
          document.body.removeChild(textarea);
        }
      }

      // Show visual feedback when copy is successful
      function showCopyFeedback(button) {
        button.classList.add("copied");
        setTimeout(() => {
          button.classList.remove("copied");
        }, 2000);
      }

      // Utility function to normalize strings for search
      function normalizeString(str) {
        return str
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase();
      }

      // Hide loading state
      function hideLoading() {
        document.getElementById("loadingState").style.display = "none";
      }

      // Show error message
      function showError(message) {
        const noResults = document.getElementById("noResults");
        const icon = noResults.querySelector("i");
        const heading = noResults.querySelector("h3");
        const paragraph = noResults.querySelector("p");

        // Update icon to error icon
        if (icon) {
          icon.className = "bx bx-error-circle";
          icon.style.fontSize = "3rem";
          icon.style.color = "#dc3545";
        }

        heading.textContent = "Error";
        paragraph.textContent = message;

        // Add retry button if it doesn't exist
        let retryButton = noResults.querySelector(".retry-button");
        if (!retryButton) {
          retryButton = document.createElement("button");
          retryButton.className = "btn btn-primary retry-button mt-3";
          retryButton.innerHTML = '<i class="bx bx-refresh"></i> Retry';
          retryButton.onclick = function () {
            retryButton.disabled = true;
            retryButton.innerHTML =
              '<i class="bx bx-loader-alt bx-spin"></i> Retrying...';
            noResults.style.display = "none";
            document.getElementById("loadingState").style.display = "flex";
            fetchDistrictContacts();
          };
          noResults.appendChild(retryButton);
        } else {
          retryButton.disabled = false;
          retryButton.innerHTML = '<i class="bx bx-refresh"></i> Retry';
          retryButton.style.display = "inline-flex";
        }

        noResults.style.display = "block";
      }

      // Handle loading timeout
      function handleLoadingTimeout() {
        hideLoading();
        showError(
          "Unable to connect to the server. Please check your internet connection and try again later."
        );
      }

      // Fetch district contacts from API
      async function fetchDistrictContacts() {
        try {
          // Set a timeout for the API call (5 seconds)
          const timeoutPromise = new Promise((_, reject) => {
            loadingTimeout = setTimeout(() => {
              reject(new Error("Request timeout"));
            }, 5000);
          });

          const fetchPromise = fetch(
            "/nmpsiaapi/DistrictContact/LoadDistrictContacts",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json;charset=utf-8",
              },
              body: JSON.stringify({}),
            }
          );

          // Race between the fetch and timeout
          const response = await Promise.race([fetchPromise, timeoutPromise]);

          // Clear the timeout since we got a response
          clearTimeout(loadingTimeout);

          if (!response.ok) {
            throw new Error("Network response was not ok");
          }

          const data = await response.json();

          if (data !== "failed") {
            allContacts = data.contacts || [];
            allDistricts = data.dists || [];
            filteredDistricts = [...allDistricts];

            hideLoading();
            // Hide error state if it was showing
            document.getElementById("noResults").style.display = "none";
            renderDistricts();
            updateStats();
          } else {
            throw new Error("API returned failed status");
          }
        } catch (error) {
          console.error("Error fetching district contacts:", error);
          clearTimeout(loadingTimeout);
          hideLoading();

          // Show appropriate error message based on the error type
          if (error.message === "Request timeout") {
            showError(
              "Request timed out. Please check your internet connection and try again."
            );
          } else if (
            error.name === "TypeError" &&
            error.message.includes("fetch")
          ) {
            showError(
              "Unable to connect to the server. This might be due to network issues or the service being temporarily unavailable."
            );
          } else {
            showError(
              "Failed to load district information. Please try again later."
            );
          }
        }
      }

      // Render districts grid
      function renderDistricts() {
        const grid = document.getElementById("districtsGrid");
        const noResults = document.getElementById("noResults");
        const icon = noResults.querySelector("i");
        const heading = noResults.querySelector("h3");
        const paragraph = noResults.querySelector("p");
        const retryButton = noResults.querySelector(".retry-button");

        if (filteredDistricts.length === 0) {
          grid.style.display = "none";
          // Reset to "no results" state (not error state)
          if (icon) {
            icon.className = "bx bx-search";
            icon.style.fontSize = "3rem";
            icon.style.color = "#6c757d";
          }
          heading.textContent = "No districts found";
          paragraph.textContent =
            "Try adjusting your search terms or browse all districts below.";
          // Hide retry button for search results, not errors
          if (retryButton) {
            retryButton.style.display = "none";
          }
          noResults.style.display = "block";
          return;
        }

        grid.style.display = "grid";
        noResults.style.display = "none";

        grid.innerHTML = filteredDistricts
          .map((district) => {
            const districtId = district.dist_id;
            const districtName =
              district.distname.split(")")[1] || district.distname;

            return `
              <div class="district-card" 
                   data-district-id="${districtId}"
                   tabindex="0"
                   role="button"
                   aria-label="View contacts for ${districtName}">
                <div class="district-id">${districtId}</div>
                <div class="district-name">${districtName}</div>
                <div class="text-muted">
                  <i class="bx bx-user"></i>
                  <span id="contact-count-${districtId}">Loading...</span> contacts
                </div>
              </div>
            `;
          })
          .join("");

        // Add event listeners to district cards
        grid.querySelectorAll(".district-card").forEach((card) => {
          card.addEventListener("click", () => handleDistrictSelection(card));
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              handleDistrictSelection(card);
            }
          });
        });

        // Update contact counts
        updateContactCounts();
      }

      // Update contact counts for each district
      function updateContactCounts() {
        allDistricts.forEach((district) => {
          const count = allContacts.filter(
            (contact) => contact.dist_id === district.dist_id
          ).length;
          const countElement = document.getElementById(
            `contact-count-${district.dist_id}`
          );
          if (countElement) {
            countElement.textContent = count;
          }
        });
      }

      // Handle district selection
      function handleDistrictSelection(card) {
        const districtId = card.dataset.districtId;
        const district = allDistricts.find((d) => d.dist_id === districtId);

        if (!district) return;

        // Update selected state
        document
          .querySelectorAll(".district-card")
          .forEach((c) => c.classList.remove("selected"));
        card.classList.add("selected");

        // Show contact details
        showContactDetails(district);
      }

      // Show contact details for selected district
      function showContactDetails(district) {
        const modalBody = document.getElementById("modalBody");
        const modalTitle = document.getElementById("contactDetailsModalLabel");
        const matchedContacts = allContacts.filter(
          (contact) => contact.dist_id === district.dist_id
        );

        const districtName =
          district.distname.split(")")[1] || district.distname;
        modalTitle.textContent = `${district.dist_id} - ${districtName}`;

        if (matchedContacts.length === 0) {
          modalBody.innerHTML = `
            <div class="text-center py-4">
              <i class="bx bx-info-circle" style="font-size: 3rem; color: #6c757d;"></i>
              <h3>No contacts found</h3>
              <p>No contact information is available for this district.</p>
            </div>
          `;
        } else {
          const firstContact = matchedContacts[0];

          modalBody.innerHTML = `
            <!-- Address Information -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="address-section">
                  <div class="address-title">
                    <i class="bx bxs-location-plus"></i>
                    Physical Address
                    <button class="copy-btn" onclick="copyToClipboard('${
                      firstContact.address1
                    }, ${firstContact.city}, ${firstContact.state} ${
            firstContact.zip
          }', this)" title="Copy physical address">
                      <i class="bx bx-copy"></i>
                    </button>
                  </div>
                  <div class="contact-field">
                    <span class="contact-value">${firstContact.address1}</span>
                  </div>
                  ${
                    firstContact.address2
                      ? `<div class="contact-field"><span class="contact-value">${firstContact.address2}</span></div>`
                      : ""
                  }
                  <div class="contact-field">
                    <span class="contact-value">${firstContact.city}, ${
            firstContact.state
          } ${firstContact.zip}</span>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="address-section">
                  <div class="address-title">
                    <i class="bx bx-envelope"></i>
                    Mailing Address
                    <button class="copy-btn" onclick="copyToClipboard('${
                      firstContact.maddress1
                    }, ${firstContact.mcity}, ${firstContact.mstate} ${
            firstContact.mzip
          }', this)" title="Copy mailing address">
                      <i class="bx bx-copy"></i>
                    </button>
                  </div>
                  <div class="contact-field">
                    <span class="contact-value">${firstContact.maddress1}</span>
                  </div>
                  ${
                    firstContact.maddress2
                      ? `<div class="contact-field"><span class="contact-value">${firstContact.maddress2}</span></div>`
                      : ""
                  }
                  <div class="contact-field">
                    <span class="contact-value">${firstContact.mcity}, ${
            firstContact.mstate
          } ${firstContact.mzip}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="contact-section">
              <h3 class="mb-4">Contact Information</h3>
              
              <!-- Responsive Contact Cards -->
              <div class="contact-cards-container">
                ${matchedContacts
                  .map(
                    (contact, index) => `
                  <div class="contact-card" role="article" aria-labelledby="contact-${index}-name">
                    <div class="contact-card-header">
                      <div class="contact-dept">
                        <i class="bx bx-building"></i>
                        ${contact.contactname}
                      </div>
                    </div>
                    <div class="contact-card-body">
                      <div class="contact-info-grid">
                        <!-- Left Column: Name and Phone -->
                        <div class="contact-info-item">
                          <div class="contact-field">
                            <i class="bx bx-user"></i>
                            <div class="contact-value" id="contact-${index}-name">
                              ${contact.name}
                            </div>
                          </div>
                          <div class="contact-field">
                            <i class="bx bx-phone"></i>
                            <div class="contact-value">
                              <a href="tel:${contact.phone.replace(
                                /\s/g,
                                ""
                              )}" class="contact-link">
                                ${contact.phone}
                              </a>
                            </div>
                          </div>
                        </div>
                        <!-- Right Column: Title and Email -->
                        <div class="contact-info-item">
                          <div class="contact-field">
                            <div class="contact-value">
                              ${contact.job_title}
                            </div>
                          </div>
                          <div class="contact-field">
                            <div class="contact-value">
                              <a href="mailto:${contact.email.toLowerCase()}" class="contact-link">
                                ${contact.email.toLowerCase()}
                              </a>
                              <button class="copy-btn" onclick="copyToClipboard('${contact.email.toLowerCase()}', this)" title="Copy email address" aria-label="Copy email address to clipboard">
                                <i class="bx bx-copy"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
          `;
        }

        // Show the modal
        const modal = new bootstrap.Modal(
          document.getElementById("contactDetailsModal")
        );
        modal.show();
      }

      // Update statistics
      function updateStats() {
        const statsBar = document.getElementById("statsBar");
        const totalDistricts = document.getElementById("totalDistricts");
        const totalContacts = document.getElementById("totalContacts");
        const filteredResults = document.getElementById("filteredResults");

        totalDistricts.textContent = allDistricts.length;
        totalContacts.textContent = allContacts.length;
        filteredResults.textContent = filteredDistricts.length;

        statsBar.style.display = "flex";
      }

      // Handle search
      function handleSearch() {
        const searchTerm = normalizeString(
          document.getElementById("searchInput").value
        );

        if (searchTerm === "") {
          filteredDistricts = [...allDistricts];
        } else {
          filteredDistricts = allDistricts.filter((district) => {
            const districtName = normalizeString(district.distname);
            const districtId = normalizeString(district.dist_id);
            return (
              districtName.includes(searchTerm) ||
              districtId.includes(searchTerm)
            );
          });
        }

        renderDistricts();
        updateStats();
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        // Add event listeners
        document
          .getElementById("searchInput")
          .addEventListener("input", handleSearch);

        // Fetch data
        fetchDistrictContacts();
      });
    </script>
  </body>
</html>
